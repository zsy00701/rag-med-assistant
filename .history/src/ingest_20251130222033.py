import os
import re
from langchain_community.vectorstores import Chroma
from langchain_openai import OpenAIEmbeddings
from langchain_core.documents import Document

SOURCE_FILE = "QA_V0.md"       # æ•°æ®æºæ–‡ä»¶è·¯å¾„
DB_PATH = "./chroma_db_medical" # å‘é‡æ•°æ®åº“åœ¨æœ¬åœ°ç¡¬ç›˜çš„å­˜å‚¨æ–‡ä»¶å¤¹

def parse_qa_file(file_path):
    # ... (è¯»å–æ–‡ä»¶å†…å®¹åˆ° content å˜é‡) ...

    # ğŸ› ï¸ æ ¸å¿ƒæ­£åˆ™è¡¨è¾¾å¼
    # r"..." : Python çš„åŸå§‹å­—ç¬¦ä¸²ï¼Œé¿å…è½¬ä¹‰ç¬¦å¹²æ‰°
    # Qï¼š(.*?) : åŒ¹é…ä»¥ "Qï¼š" å¼€å¤´çš„å†…å®¹ï¼Œ(.*?) æ˜¯éè´ªå©ªåŒ¹é…ï¼ŒåªåŒ¹é…åˆ°ä¸‹ä¸€ä¸ªæ¡ä»¶ä¹‹å‰
    # \n+Aï¼š   : åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªæ¢è¡Œç¬¦åç´§æ¥ "Aï¼š"
    # (.*?)    : åŒ¹é…ç­”æ¡ˆå†…å®¹
    # (?=\n+Qï¼š|$) : æ­£å‘é¢„æŸ¥ï¼ˆLookaheadï¼‰ã€‚æ„æ€æ˜¯â€œåŒ¹é…ç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ª 'Qï¼š' æˆ–è€…æ–‡ä»¶ç»“æŸä¸ºæ­¢â€ã€‚
    #                è¿™éå¸¸é‡è¦ï¼Œå®ƒé˜²æ­¢äº†ä¸€ä¸ª Q åŒ¹é…äº†æ•´ä¸ªæ–‡ä»¶å‰©ä¸‹çš„æ‰€æœ‰å†…å®¹ã€‚
    pattern = r"Qï¼š(.*?)\n+Aï¼š(.*?)(?=\n+Qï¼š|$)"
    
    # re.DOTALL : è®© '.' ç¬¦å·å¯ä»¥åŒ¹é…æ¢è¡Œç¬¦ã€‚å› ä¸ºç­”æ¡ˆé€šå¸¸æ˜¯å¤šè¡Œçš„ï¼Œä¸åŠ è¿™ä¸ªå‚æ•°åªèƒ½åŒ¹é…å•è¡Œã€‚
    matches = re.findall(pattern, content, re.DOTALL)
    
    # ... (å°†åŒ¹é…ç»“æœæ•´ç†æˆå­—å…¸åˆ—è¡¨) ...
    return qa_pairs

# è½¬æ¢ LangChain Document
    documents = []
    for item in qa_list:
        # ğŸ’¡ æ ¸å¿ƒç­–ç•¥ï¼šå†…å®¹æ‹¼æ¥
        # page_content æ˜¯å‘é‡åŒ–æ¨¡å‹çœŸæ­£â€œè¯»â€åˆ°çš„å†…å®¹ã€‚
        # æˆ‘ä»¬æŠŠ "é—®é¢˜" å’Œ "ç­”æ¡ˆ" æ‹¼åœ¨ä¸€èµ·ã€‚
        # å¥½å¤„ï¼š
        # 1. å¦‚æœç”¨æˆ·æœé—®é¢˜é‡Œçš„è¯ï¼ˆå¦‚â€œè‚è±†çŠ¶æ ¸å˜æ€§â€ï¼‰ï¼Œèƒ½åŒ¹é…ä¸Šã€‚
        # 2. å¦‚æœç”¨æˆ·æœç­”æ¡ˆé‡Œçš„ç—‡çŠ¶ï¼ˆå¦‚â€œé“œä»£è°¢éšœç¢â€ï¼‰ï¼Œä¹Ÿèƒ½åŒ¹é…ä¸Šã€‚
        content = f"é—®é¢˜ï¼š{item['question']}\nç­”æ¡ˆï¼š{item['answer']}"
        
        # metadata æ˜¯å…ƒæ•°æ®ï¼Œä¸å‚ä¸å‘é‡è®¡ç®—ï¼Œä½†æ£€ç´¢æ—¶ä¼šåŸæ ·è¿”å›ã€‚
        # ç”¨äºå‰ç«¯æ˜¾ç¤ºâ€œå¼•ç”¨æ¥æºâ€æˆ–åšåç»­çš„æ•°æ®è¿½è¸ªã€‚
        metadata = {
            "source": SOURCE_FILE,
            "original_q": item['question']
        }
        
        doc = Document(page_content=content, metadata=metadata)
        documents.append(doc)